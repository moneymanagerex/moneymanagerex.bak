<?xml version="1.0" ?>

<!-- 
    MMEX build scripts.
    Copyright (C) 2009 VaDiM.

    MMEX Unit Tests application.
-->

<makefile>

    <!-- Default root of sources is dir where output script will be created.
         autoconf generates Makefile in trunk/mmex/src/tests but others in trunk/mmex/build/msw/tests.
    -->

    <if cond="FORMAT=='autoconf'">
        <set-srcdir>../..</set-srcdir>
    </if>

    <if cond="FORMAT!='autoconf'">
        <set-srcdir>../../..</set-srcdir>
    </if>
    
    
    <include file="../../build/bakefiles/common.bkl"/>
    <include file="../../build/bakefiles/UnitTest++.bkl"/>


    <!-- unit tests console application -->

    <exe id="mmex_tests" template="mmex_common">

        <app-type>console</app-type>
        <library>UnitTestPP</library>

	<include>$(SRCDIR)/src</include>
	<include>$(SRCDIR)/libs/UnitTest++</include>


    	<!-- IMPLEMENT_APP(mmGUIApp) in mmex.cpp defines main() on Unixes, see wx\app.h.
             But mmex_tests.cpp also defines main(). 
        -->

        <if cond="TOOLSET=='unix'">
            <define>IMPLEMENT_WXWIN_MAIN=</define>
        </if>


    	<!-- relative to trunk/mmex -->

    	<set var="SRC">src/tests</set>

        <headers>$(fileList(SRC + '/*.h'))</headers>
        <sources>$(fileList(SRC + '/*.cpp'))</sources>

        <win32-res>$(SRC)/mmex_tests.rc</win32-res>

    </exe>

    
    <!-- 
         make check
         All formats expect MS VisualStudio projects.
    -->

    <action id="check" cond="not FORMAT.endswith('prj')">

        <depends>all</depends>
	<is-phony>on</is-phony>

    	<set var="COPY">
            <if cond="TOOLSET=='win32'">copy /Y</if>
            <if cond="TOOLSET=='unix'">cp</if>
        </set>

        <!-- && is "&amp;&amp;" in HTML -->

        <command cond="FORMAT!='autoconf'">
            <!-- can't get executable dir if autoconf -->
            cd $(nativePaths(SRCDIR + '/runtime')) &amp;&amp; $('..\\build\\msw\\tests\\' + BUILDDIR + '\\mmex_tests' + EXEEXT)
        </command>

        <command cond="FORMAT=='autoconf'">
            $(COPY) $(nativePaths(SRCDIR + '/runtime/currency_seed.db3')) $(nativePaths(BUILDDIR))
            ./mmex_tests
	</command>

        <clean-files  cond="FORMAT=='autoconf'">$(nativePaths(BUILDDIR + '/currency_seed.db3'))</clean-files>

    </action>


</makefile>
